version: '3.8'

services:
  backend:
    build: ./backend
    container_name: job-radar-backend
    restart: unless-stopped
    # Run as root to fix SQLite volume permissions (pptruser cannot write to /data)
    user: root
    volumes:
      # Use a named volume for SQLite data persistence
      # This prevents the "directory over file" mount error
      - sqlite_data:/data
      # Persist Uploads
      - ./uploads:/usr/src/app/uploads
    environment:
      # Point Prisma to the persistent volume path
      - DATABASE_URL=file:/data/dev.db
      - PORT=3001
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/google-chrome-stable
    # Ensure migrations run on startup
    command: sh -c "npx prisma migrate deploy && npm start"

  frontend:
    build: ./frontend
    container_name: job-radar-frontend
    restart: unless-stopped
    ports:
      # Map container port 80 to host port 5173 (less likely to be taken)
      - "5173:80"
    depends_on:
      - backend

volumes:
  sqlite_data:
